#!/bin/sh
set -eu
# ==============================================================================
# SCRIPT:      session (POSIX sh version)
# ==============================================================================

for tool in crudini fzf tmux realpath; do
    if ! command -v "$tool" >/dev/null 2>&1; then
        echo "Error: Required tool '$tool' not installed." >&2
        exit 1
    fi
done

getval() {
    _rcfile="$HOME/.config/tmux/sessionrc"
    [ ! -f "$_rcfile" ] && return 1

    if [ -z "${1:-}" ] && [ -z "${2:-}" ]; then
        _re_squaredbrackets='s/^\[\(.*\)\]$/\1/p'
        sed -n "$_re_squaredbrackets" "$_rcfile" || true
        exit 0
    fi
    _key="${1:-}"

    _section="${2:-DEFAULT}"
    _val=$(crudini --get "$_rcfile" "$_section" "$_key" 2>/dev/null || true)

    _re_remove_comments_spaces='s/[[:space:]]*#.*$//; s/[[:space:]]*$//'
    _re_remove_single_double_quotes="s/^['\"]//; s/['\"]$//"
    _val=$(echo "$_val" | sed "$_re_remove_comments_spaces")
    _val=$(echo "$_val" | sed "$_re_remove_single_double_quotes")
    _val=$(echo "$_val" | sed "s,^~,$HOME,")

    echo "$_val"
}

PROJECT_ROOTS=$(getval 'project_roots')
DEFAULT_STARTUP=$(getval 'startup_command')
sections=$(getval)
selected=""
startup_cmd=""

# 1. Check if argument is already a valid directory
if [ -n "${1:-}" ]; then
    expanded_arg=$(echo "$1" | sed "s,^~,$HOME,")

    if [ -d "$expanded_arg" ]; then
        selected="$expanded_arg"
    fi
fi

# 2. Check aliases in config
if [ -z "$selected" ] && [ -n "$sections" ]; then
    for section in $sections; do
        aliases=$(getval aliases "$section" | tr ',' ' ')
        name="${section#*.}"

        if [ -n "${1:-}" ]; then
            if echo " $aliases " | grep -q " $1 " || [ "$1" = "$name" ]; then
                selected=$(getval path "$section")
                startup_cmd=$(getval startup_command "$section")
                break
            fi
        fi
    done
fi

# 3. Fallback to fzf
if [ -z "$selected" ]; then
    _roots="${PROJECT_ROOTS:-$HOME}"
    _valid_roots=""
    for _r in $_roots; do
        # ExpansÃ£o de tilde para cada root
        case "$_r" in ~*) _r="$HOME${_r#~}" ;; esac
        [ -d "$_r" ] && _valid_roots="$_valid_roots $_r"
    done

    if [ -n "$_valid_roots" ]; then
        # shellcheck disable=SC2086
        selected=$(find $_valid_roots -mindepth 1 -maxdepth 1 -type d 2>/dev/null | fzf --header="Select Session" --query="${1:-}")
    fi
fi

if [ -z "$selected" ]; then
    exit 0
fi

cmd="${startup_cmd:-$DEFAULT_STARTUP}"
selected=$(realpath "$selected")

if [ ! -d "$selected" ]; then
    echo "Selected path is not a directory: $selected" >&2
    exit 1
fi

# Sanitize tmux name
tmux_name=$(basename "$selected" | sed 's/[^[:alnum:]_-]/_/g')

if [ -n "${TMUX:-}" ]; then
    current_session=$(tmux display-message -p '#S' 2>/dev/null)
    current_dir=$(realpath "$PWD" 2>/dev/null || printf '%s' "$PWD")

    if [ "$current_session" = "$tmux_name" ]; then
        case "$current_dir" in
        "$selected" | "$selected/"*) ;;
        *)
            if [ -n "${TMUX_PANE:-}" ]; then
                # Using printf %q for safe quoting
                _safe_path=$(printf '%s' "$selected" | sed "s/'/'\\\\''/g; 1s/^/'/; \$s/\$/'/")
                tmux send-keys -t "$TMUX_PANE" "cd $_safe_path" C-m
            fi
            ;;
        esac
        exit 0
    fi

    if ! tmux has-session -t="$tmux_name" 2>/dev/null; then
        tmux new-session -ds "$tmux_name" -c "$selected"
        if [ -n "$cmd" ]; then
            tmux send-keys -t "$tmux_name" "$cmd" C-m
        fi
    fi
    tmux switch-client -t "$tmux_name"
    exit 0
fi

if tmux has-session -t="$tmux_name" 2>/dev/null; then
    exec tmux attach-session -t "$tmux_name"
fi

if [ -n "$cmd" ]; then
    exec tmux new-session -s "$tmux_name" -c "$selected" "$cmd"
else
    exec tmux new-session -s "$tmux_name" -c "$selected"
fi
