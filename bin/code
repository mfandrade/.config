#!/usr/bin/env bash

# Atalhos rápidos: mude conforme sua necessidade
# Exemplo: code.sh config -> vai direto para o nvim
case $1 in
"nvim" | "vim" | "n" | "v")
  selected="$HOME/.config/nvim"
  ;;
"tmux" | "t")
  selected="$HOME/.config/tmux"
  ;;
"ts")
  selected="$HOME/src/typescript-for-developers/"
  ;;
*)
  # Se não houver argumento ou não bater com os atalhos, fzf
  PROJECT_ROOTS=(
    "$HOME/src"
  )

  # Filtro de erro: garante que diretórios inexistentes no array não quebrem o find
  VALID_ROOTS=()
  for root in "${PROJECT_ROOTS[@]}"; do
    [[ -d "$root" ]] && VALID_ROOTS+=("$root")
  done

  selected=$(find "${VALID_ROOTS[@]}" -mindepth 1 -maxdepth 1 -type d |
    sort -r | fzf -d '/' --with-nth '-2..-1')
  ;;
esac

if [[ -z $selected ]]; then
  exit 0
fi

# Garante path absoluto e resolve links simbólicos
selected=$(realpath "$selected")
tmux_name=$(basename "$selected" | tr . _)
tmux_running=$(pgrep tmux)

# Se o Tmux não está rodando, inicia a sessão e já entra nela
if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
  tmux new-session -s "$tmux_name" -c "$selected"
  exit 0
fi

# Se a sessão específica não existe, cria em background
if ! tmux has-session -t="$tmux_name" 2>/dev/null; then
  tmux new-session -ds "$tmux_name" -c "$selected"
fi

# Lógica de entrada/troca
if [[ -z $TMUX ]]; then
  # Se você está no terminal puro, anexa à sessão
  tmux attach-session -t "$tmux_name"
else
  # Se você já está dentro do tmux, troca o cliente (o 'salto' instantâneo)
  tmux switch-client -t "$tmux_name"
fi
